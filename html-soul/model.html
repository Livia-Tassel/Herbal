<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/common.css">
    <title>草药仙踪</title>
    <style>
        .wrapper {
            position: relative;
            flex-direction: column;
        }

        .wrapper .back {
            width: 281px;
            height: 79px;
            display: flex;
            justify-content: space-between;
            position: absolute;
            left: 40px;
            top: 27px;
        }

        .back .return-button {
            width: 43px;
            height: 79px;
            background-image: url(../pic/pic-ink@2x.png);
            background-size: 43px 79px;
            background-repeat: no-repeat;
            text-align: center;
            font-size: 24px;
            color: #FFFFFF;
            line-height: 30px;
            padding: 10px 9px;
        }

        .back .text-box {
            width: 220px;
            height: 79px;
            display: flex;
            flex-direction: column;
        }

        .back .text-box h2 {
            width: 220px;
            height: 25px;
            padding-top: 6px;
            line-height: 19px;
            font-size: 18px;
            color: #8B5634;
            text-align: left;
        }

        .back .text-box h3 {
            width: 220px;
            height: 21px;
            font-size: 14px;
            color: rgba(42, 42, 42, 0.4);
            text-align: left;
            line-height: 15px;
            padding-bottom: 5px;
            border-bottom: 1.5px solid #8B5634;
            display: inline-block;
            box-sizing: border-box;
            margin-top: 16px;
        }

        .content {
            width: 917px;
            height: 477px;
            background-image: url(../pic/soul/test/main-box.svg); /* Reusing the box svg */
            margin: 0 auto;
            margin-top: 160px;
            display: flex;
            justify-content: space-between;
            z-index: 2;
            position: relative;
            padding: 30px; 
            box-sizing: border-box;
        }

        .flower{
            height: 417px; /* Adjusted height to fit padding */
            width: 56px;
            background-image: url(../pic/pic-goldflower.png);
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 36px 36px;
        }
        
        .img-herb {
            position: absolute;
            width: 247px;
            height: 399px;
            opacity: 0.17;
            background-image: url(../pic/soul/test/pic-herb.png);
            top: 0px;
            right: 0px;
            z-index:1;
        }

        /* Interaction Area Styles */
        .assistant-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .mode-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }

        .mode-tab {
            font-size: 20px;
            color: #8B5634;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .mode-tab.active {
            border-bottom: 3px solid #8B5634;
            font-weight: bold;
        }

        .input-area {
            width: 600px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-area input {
            flex: 1;
            height: 50px;
            border: 2px solid #8B5634;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.6);
            padding: 0 20px;
            font-size: 18px;
            color: #6E5B5B;
            outline: none;
        }

        .input-area button {
            width: 100px;
            height: 50px;
            background: #8B5634;
            color: #fff;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .input-area button:hover {
            background: #A06540;
        }

        /* Popup Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .window {
            width: 785px;
            height: 661px;
            background-image: url(../pic/soul/test/pic-winbox.png); 
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 100px 100px 50px 100px; /* Padding to fit content inside the box graphic */
            box-sizing: border-box;
        }

        .close-btn {
            position: absolute;
            top: 80px;
            right: 100px;
            font-size: 30px;
            background: none;
            border: none;
            cursor: pointer;
            color: #8B5634;
        }

        .answer-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            text-align: left;
            padding-right: 10px;
        }

        .answer-content h2 {
            color: #BA4A23;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }

        .answer-content p {
            color: #535353;
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .answer-content strong {
            color: #9D6345;
            font-weight: bold;
        }
        
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="img-herb"></div>
        <div class="back">
            <a href="../soul.html">
                <div class="return-button">返回</div>
            </a>
            <div class="text-box">
                <h3>草药仙灵</h3>
                <h2>草药助手</h2>
            </div>
        </div>
        <div class="content">
            <div class="flower"></div>
            <div class="assistant-container">
                <div class="mode-tabs">
                    <div class="mode-tab active" onclick="setMode('recipe')">求方模式</div>
                    <div class="mode-tab" onclick="setMode('theory')">问道模式</div>
                    <div class="mode-tab" onclick="setMode('chat')">闲聊模式</div>
                </div>
                <div class="input-area">
                    <input type="text" id="userQuestion" placeholder="请输入您的问题...">
                    <button onclick="askQuestion()">提问</button>
                </div>
            </div>
            <div class="flower"></div>
        </div>
    </div>

    <!-- Popup Window -->
    <div class="overlay" id="answerOverlay">
        <div class="window">
            <button class="close-btn" onclick="closePopup()">×</button>
            <div class="answer-content" id="answerText">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'recipe'; // Default mode

        // Data Source
        const qaData = {
            recipe: [
                {
                    keywords: ["疲倦", "食少", "腹胀", "食补", "脾胃"],
                    title: "山药小米粥",
                    content: `<strong>这是脾胃虚弱的表现。当身体出现脾胃虚弱（常见表现：食欲不振、腹胀便溏、体倦乏力、舌淡苔白）时，可通过温和、易消化、健脾益胃的食补来调理。</strong><br><br>
                    <strong>适合情况：</strong>脾胃气虚、食少纳呆、腹胀便溏者。<br>
                    <strong>食材：</strong>小米约50克；山药约100克（切块）；水适量（粥状比例，可根据口感调整）；可选：少量红枣或枸杞点缀。<br>
                    <strong>做法：</strong>小米洗净，山药去皮切块。锅中加适量水，先将小米煮至约八成软。加入山药块，小火继续煮至粥稠、山药软烂。最后可加入少许红枣或枸杞，煮几分钟即可。<br>
                    <strong>功效提示：</strong>小米健脾和胃，山药补脾养胃、生津益肺。适用于脾胃虚弱人群。<br>
                    <strong>注意事项：</strong>避免与大量生冷、油腻食物一起食用；若体质偏寒，早上食用更为适宜。`
                },
                {
                    keywords: ["月经", "不调", "面色", "苍白", "血虚"],
                    title: "乌鸡益母草当归炖汤",
                    content: `<strong>月经不调在中医里这类情况常归于“血虚”或“血瘀”证，可通过以下食补来调理。</strong><br><br>
                    <strong>补气血、调经止带</strong><br>
                    <strong>食材：</strong>乌鸡（整只或半只）；当归约10-15克；益母草约10-12克；黄芪或党参各约10克；生姜几片、红枣若干。<br>
                    <strong>做法：</strong>乌鸡洗净切块焯水。将所有食材入炖盅，加适量清水炖约1-2小时至鸡肉软烂。即食。<br>
                    <strong>功效：</strong>乌鸡滋补、当归养血活血、益母草调经活血，此方适合气血两虚、月经不调、经量少或经期延长者。<br>
                    <strong>注意：</strong>若有明显血热（如面红目赤、口干舌红）或湿热症状，应避免过度补血活血。`
                },
                {
                    keywords: ["秋冬", "皮肤干燥", "咽喉", "燥"],
                    title: "滋阴生津食养",
                    content: `<strong>一到秋天，总觉得喝再多水还是渴？那是因为你缺的不只是“水”，而是“津液”！</strong><br><br>
                    <strong>津液不足，百病来袭。</strong>津液是我们身体里的“滋润之源”，它不只是水，更是能被身体吸收利用、润泽脏腑的液态营养。<br>
                    单纯喝水，很可能只是“穿肠过”，甚至加重脾胃负担，而真正的津液亏虚，需要的是滋阴生津的食养搭配，如银耳、百合、梨等炖汤。`
                }
            ],
            theory: [
                {
                    keywords: ["诊治", "原理", "阴阳"],
                    title: "中医诊治原理",
                    content: `中医认为人体是一个阴阳动态平衡的系统，阴代表静、寒、内，阳代表动、热、外。健康即阴阳协调，当偏盛或偏衰时便出现疾病。<br>
                    例如阳盛则发热、口渴、面赤；阴盛则畏寒、四肢冰冷。<br>
                    治疗上讲求“寒者热之，热者寒之”，通过药物或针灸等手段调和阴阳，恢复平衡。阴阳学说是中医诊断、辨证与施治的核心理论。`
                },
                {
                    keywords: ["五行", "脏腑", "关系"],
                    title: "五行学说与脏腑",
                    content: `五行学说将自然界和人体分为木、火、土、金、水五种属性，分别对应肝、心、脾、肺、肾五脏。<br>
                    例如木主生发，对应肝；火主温热，对应心；水主滋润，对应肾。<br>
                    五脏间相生相克，如肝木生心火、心火生脾土。疾病常因五行失衡而起，中医据此分析病机，调整脏腑功能，从整体上达到调养目的。`
                },
                {
                    keywords: ["性味", "归经"],
                    title: "什么是“性味与归经”",
                    content: `中药讲究“性、味、归经”。<br>
                    <strong>性：</strong>指寒、热、温、凉四性。<br>
                    <strong>味：</strong>有辛、甘、酸、苦、咸五味；不同性味决定药物作用方向。<br>
                    <strong>归经：</strong>指药物对特定脏腑或经络的作用倾向，如黄连苦寒，归心经、胃经，能清心火、泻胃热。<br>
                    通过配伍不同性味与归经的药物，医生可实现“君臣佐使”的协同疗效，体现中医整体辨证的用药思想。`
                },
                {
                    keywords: ["人参", "百草之王"],
                    title: "人参——百草之王",
                    content: `人参性微温、味甘微苦，入脾、肺经，具有大补元气、复脉固脱、补脾益肺、生津安神等功效。<br>
                    自古被誉为“百草之王”，因为它能调节机体整体功能，对虚弱、疲劳、免疫力下降等症状均有效。<br>
                    人参含多种皂苷、糖类及挥发油成分，能增强中枢神经系统和心血管系统功能。无论用于病后康复还是延缓衰老，都体现了其全面的“补气养元”作用。`
                },
                {
                    keywords: ["黄连", "苦", "清热"],
                    title: "黄连为何苦而能清热？",
                    content: `黄连味极苦，性大寒，入心、胃、大肠、肝、胆经，主要功效为清热燥湿、泻火解毒。<br>
                    其苦味源自生物碱如小檗碱、黄连碱等成分，这些成分能抑制细菌生长、降低体温并减少炎症反应。<br>
                    中医认为“苦能泄能燥”，黄连以苦入心、以寒除热，特别适用于治疗口舌生疮、胃火亢盛、痢疾等症，是典型的“苦寒药”代表。`
                },
                {
                    keywords: ["艾草", "端午"],
                    title: "艾草与端午",
                    content: `艾草性温、味苦辛，入肝、脾、肾经，具有温经止血、散寒止痛、祛湿除秽的功效。<br>
                    古人认为端午时节阳气最盛、瘟疫易发，悬挂艾草可驱邪避秽、净化空气。<br>
                    其挥发油中含有多种芳香成分，如侧柏酮、桉油精等，具杀菌、防虫作用。艾草既是中药材，也是民俗文化的重要象征，体现了中医“药食同源、人与自然协调”的思想。`
                }
            ],
            chat: [
                {
                    keywords: ["夏天", "上火", "茶"],
                    title: "夏日清凉茶饮",
                    content: `<strong>夏季气温高、出汗多，容易“上火”导致咽喉痛、口腔溃疡等。</strong><br>
                    可选择清热解毒的金银花、菊花、薄荷、决明子泡茶饮用。<br>
                    金银花清热解毒、薄荷疏风散热，菊花能明目平肝，决明子有助降火润肠。<br>
                    注意茶饮不宜过浓或过量，以免损伤脾胃。每天一两杯清凉茶，有助于调节体内阴阳平衡、缓解燥热。`
                },
                {
                    keywords: ["感冒", "流鼻涕", "调理"],
                    title: "感冒初起调理",
                    content: `<strong>感冒分风寒与风热两类。</strong><br>
                    若是受凉后怕冷、流清涕，可用生姜、葱白、苏叶煮水发汗；<br>
                    若咽喉痛、流黄涕、口干，可用菊花、金银花、连翘等泡茶清热。<br>
                    中医讲“治未病”，感冒初期重在驱邪外出，切忌盲目服用退烧药。多喝温水、保证睡眠，也有助于身体恢复正气。`
                },
                {
                    keywords: ["熬夜", "上火"],
                    title: "熬夜上火调理",
                    content: `中医认为熬夜伤阴、耗气，易导致心火亢盛、肝气郁结，出现口腔溃疡、眼干、长痘等。<br>
                    可用枸杞、菊花、桑叶泡水，起到养肝明目、清热平火的作用。<br>
                    饮食上宜多吃清淡蔬菜和水果，少食辛辣油腻。<br>
                    规律作息、适度运动是根本调养之道，中药只能辅助，关键在于恢复阴阳平衡与气血调畅。`
                },
                {
                    keywords: ["痛经", "女性"],
                    title: "女性痛经调理",
                    content: `痛经多与寒凝血瘀或气滞不畅有关。艾叶、当归、红花是常用药材，其中艾叶温经止痛、当归补血活血、红花活血通经。<br>
                    可在经前或经期饮用当归红枣茶或艾叶生姜水，起到温经散寒、调理气血的作用。<br>
                    平时注意保暖、避免生冷食品，是预防痛经的重要生活习惯。`
                },
                {
                    keywords: ["秋冬", "皮肤干燥"],
                    title: "秋冬养阴润燥",
                    content: `秋冬气候干燥，中医称“燥伤津液”。<br>
                    可用麦冬、沙参、百合、银耳煮汤饮用，具有养阴润肺、生津止渴的功效。<br>
                    银耳被誉为“平民燕窝”，能补而不腻；麦冬、沙参滋阴润喉，适合长期面对空调或电子屏的人群。<br>
                    外用可搭配芝麻油、当归膏，内外兼养，使皮肤恢复光泽。`
                },
                {
                    keywords: ["睡眠", "失眠"],
                    title: "中药调节睡眠",
                    content: `失眠多与心脾两虚、肝郁化火或阴虚火旺有关。<br>
                    常用药材如酸枣仁、柏子仁、夜交藤、百合等，能养心安神、改善睡眠。<br>
                    可在睡前泡酸枣仁百合茶饮，帮助放松情绪。<br>
                    睡前避免咖啡、电子产品刺激，保持房间安静与温度适宜。中药调理讲究“养心为本”，重在持之以恒、调神养气。`
                }
            ]
        };

        function setMode(mode) {
            currentMode = mode;
            // Update UI tabs
            document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
            // Find the tab with the correct text content roughly or by index, 
            // but easier to just use the order or add data attributes. 
            // Let's assume order: Recipe(0), Theory(1), Chat(2)
            const index = mode === 'recipe' ? 0 : mode === 'theory' ? 1 : 2;
            document.querySelectorAll('.mode-tab')[index].classList.add('active');
            
            // Clear input for better UX? Or keep it? Let's keep it.
        }

        // Enter key to submit
        document.getElementById('userQuestion').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });

        // Debugging function to help identify the issue
        function askQuestion() {
            const input = document.getElementById('userQuestion').value.trim();
            if (!input) {
                alert("请输入您的问题");
                return;
            }

            console.log("Input:", input);
            console.log("Current Mode:", currentMode);

            const data = qaData[currentMode];
            if (!data) {
                alert("Error: Invalid mode selected");
                return;
            }

            let bestMatch = null;
            let maxMatches = 0;

            // Simple keyword matching logic
            for (const item of data) {
                let matches = 0;
                for (const keyword of item.keywords) {
                    if (input.includes(keyword)) {
                        matches++;
                    }
                }
                console.log(`Checking item: ${item.title}, Matches: ${matches}`);
                if (matches > maxMatches) {
                    maxMatches = matches;
                    bestMatch = item;
                }
            }

            if (bestMatch && maxMatches > 0) {
                console.log("Best Match Found:", bestMatch.title);
                showAnswer(bestMatch);
            } else {
                console.log("No match found");
                showAnswer({
                    title: "仙灵未解",
                    content: "仙灵暂未参透此问，请尝试更换关键词，或切换模式提问。（提示：尝试包含关键词如“食补”、“脾胃”、“上火”等）"
                });
            }
        }

        function showAnswer(data) {
            const overlay = document.getElementById('answerOverlay');
            const answerText = document.getElementById('answerText');
            
            answerText.innerHTML = `
                <h2>${data.title}</h2>
                <p>${data.content}</p>
            `;
            
            overlay.style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('answerOverlay').style.display = 'none';
        }
    </script>
</body>

</html>